@page "/supplier-orders"
@using IMS.Helpers
@using IMS_Shared.Dtos
@using System.ComponentModel.DataAnnotations
@inject InventoryApiClient ApiClient
@rendermode InteractiveServer
@attribute [StreamRendering]

<h3>Supplier Orders</h3>

<hr />

@if (isLoading == null)
{
    <p>The page had problems loading.</p>
    <p>Error: @errorMessage</p>
    <br />
    <p>Please reload the page.</p>
}
else if (isLoading.Value)
{
    <p>Loading...</p>
}
else
{
    <h4>Create New Supplier Order</h4>

    <div>
        <label>Supplier:</label>
        <select @bind="NewOrder.SupplierId">
            <option>Choose a supplier</option>
            @foreach (var s in suppliers)
            {
                <option value="@s.Id">@s.Name</option>
            }
        </select>
    </div>

    <br />

    if (stocks.Any(x => x.SupplierId == NewOrder.SupplierId))
    {
        <div>
            <label>Add Items:</label>

            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var stock in stocks.Where(x => x.SupplierId == NewOrder.SupplierId))
                    {
                        <tr>
                            <td>@stock.Name</td>
                            <td> <input type="number" min="0" @bind="NewOrderItems[stock.StockId ?? -1]" /></td>
                        </tr>
                    }
                </tbody>
            </table>

        </div>
    }
    else
    {
        <p>No items exist for supplier @suppliers.FirstOrDefault(x => x.Id == NewOrder.SupplierId)?.Name.</p>
    }

    <br />

    <button class="btn btn-primary" @onclick="CreateOrder">Create Order</button>

    <hr />

    @foreach (var order in orders)
    {
        <div class="card mb-2">
            <div class="card-header" @onclick="() => Toggle(order.Id)">
                <b>Order #@order.Id</b> - @order.Supplier.Name - @order.CreatedDate.ToLocalTime().ToShortDateString()
                <span class="badge
                                                            @(order.Status == IMS_Shared.Enums.OrderStatus.Canceled ? "bg-danger" :
                                                                                                                                                                              order.Status == IMS_Shared.Enums.OrderStatus.Pending ? "bg-warning text-dark" :
                                                                                                                                                                              order.Status == IMS_Shared.Enums.OrderStatus.Received ? "bg-success" : "bg-secondary")">
            @order.Status
        </span>
        @if (order.StatusChangeDate != null)
                {
                    @if (order.Status == IMS_Shared.Enums.OrderStatus.Canceled)
                    {
                        <span>
                            Canceled on @order.StatusChangeDate?.ToLocalTime()
                        </span>
                    }
                    else if (order.Status == IMS_Shared.Enums.OrderStatus.Received)
                    {
                        <span>
                            Received on @order.StatusChangeDate?.ToLocalTime()
                        </span>
                    }
                }
            </div>

            @if (ExpandedOrders.Contains(order.Id))
            {
                <div class="card-body">

                    @if (order.Status == IMS_Shared.Enums.OrderStatus.Pending)
                    {
                        <button class="btn btn-success btn-sm" @onclick="() => MarkOrderReceived(order.Id)">
                            Mark Entire Order Received
                        </button>

                        <button class="btn btn-danger btn-sm ms-2" @onclick="() => CancelOrder(order.Id)">
                            Cancel Order
                        </button>
                    }

                    <table class="table mt-3">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in order.Items)
                            {
                                <tr>
                                    <td>@item.Name</td>
                                    <td>@item.Amount</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }
}

@code {

    List<SupplierOrderDto> orders = new();
    List<SupplierDto> suppliers = new();
    List<StockDto> stocks = new();
    Dictionary<int, int> NewOrderItems = new();
    CreateSupplierOrderDto NewOrder = new();
    HashSet<int> ExpandedOrders = new();

    private bool? isLoading = true;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var orderTask = GetSupplierOrdersAsync();
        var supplierTask = GetSuppliersAsync();
        var stockTask = GetAllStocksAsync();

        await Task.WhenAll(orderTask, supplierTask, stockTask);

        ResetNewOrderItems();

        if (isLoading != null)
            isLoading = false;
    }

    private async Task GetSupplierOrdersAsync()
    {
        var result = await ApiClient.GetSupplierOrdersAsync();
        if (!result.Success)
        {
            errorMessage = result.Error;
            isLoading = null;
            return;
        }

        orders = result.Data ?? [];
    }

    private async Task GetSuppliersAsync()
    {
        var result = await ApiClient.GetSuppliersAsync();
        if (!result.Success)
        {
            errorMessage = result.Error;
            isLoading = null;
            return;
        }

        suppliers = result.Data ?? [];
    }

    private async Task GetAllStocksAsync()
    {
        var result = await ApiClient.GetAllStocksAsync();
        if (!result.Success)
        {
            errorMessage = result.Error;
            isLoading = null;
            return;
        }

        stocks = result.Data ?? [];
    }

    void ResetNewOrderItems()
    {
        NewOrderItems = stocks.ToDictionary(s => s.StockId ?? 0, s => 0);
    }

    void Toggle(int id)
    {
        if (ExpandedOrders.Contains(id))
            ExpandedOrders.Remove(id);
        else
            ExpandedOrders.Add(id);
    }

    async Task MarkOrderReceived(int orderId)
    {
        var result = await ApiClient.MarkOrderReceivedAsync(orderId);
        if (!result.Success)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {result.Error}");
            return;
        }

        await Load();
    }

    async Task CancelOrder(int id)
    {
        var result = await ApiClient.CancelOrderAsync(id);
        if (!result.Success)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {result.Error}");
            return;
        }

        await Load();
    }

    async Task CreateOrder()
    {
        NewOrder.Items = NewOrderItems
            .Select(x => new OrderItemDto
            {
                StockId = x.Key,
                Amount = x.Value
            })
            .ToList();

        var result = await ApiClient.CreateSupplierOrderAsync(NewOrder);
        if (!result.Success)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {result.Error}");
            return;
        }

        ResetNewOrderItems();

        await Load();
    }

    async Task Load()
    {
        await GetSupplierOrdersAsync();
        StateHasChanged();
    }

    [Inject] IJSRuntime JS { get; set; } = default!;
}